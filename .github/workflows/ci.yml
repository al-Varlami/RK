name: CI/CD Pipeline with Reliable Builds
on:
  push:
    branches: [master]
  release:
    types: [created, edited]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: ${{ github.workspace }}
      BUILD_DIR: ${{ github.workspace }}/build
      INSTALL_DIR: ${{ github.workspace }}/pkg/usr/local/bin

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clean workspace
      run: |
        echo "–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
        rm -rf "$BUILD_DIR" "$INSTALL_DIR" artifacts/ pkg/
        mkdir -p "$BUILD_DIR"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake=3.22* \
          g++=10.3* \
          build-essential \
          libgtest-dev=1.11* \
          dpkg \
          file

    - name: Configure project
      working-directory: $BUILD_DIR
      run: |
        echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
        echo "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: $SOURCE_DIR"
        echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–±–æ—Ä–∫–∏: $BUILD_DIR"
        cmake "$SOURCE_DIR" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DVERSION_SUFFIX=-$(date +%Y%m%d-%H%M%S)

    - name: Build project
      working-directory: $BUILD_DIR
      run: |
        echo "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
        make -j$(nproc) VERBOSE=1
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞:"
        file Behavioral/Observer/observer_demo
        ldd Behavioral/Observer/observer_demo || true

    - name: Create DEB package
      run: |
        echo "–°–æ–∑–¥–∞–Ω–∏–µ DEB-–ø–∞–∫–µ—Ç–∞..."
        mkdir -p "$INSTALL_DIR"
        install -m 755 "$BUILD_DIR/Behavioral/Observer/observer_demo" "$INSTALL_DIR"/
        
        mkdir -p pkg/DEBIAN
        cat <<EOF > pkg/DEBIAN/control
        Package: observer-pattern
        Version: 1.0-$(date +%Y%m%d-%H%M%S)
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        Description: Observer Pattern Implementation
        Depends: libc6 (>= 2.31)
        EOF
        
        dpkg-deb --build pkg
        mkdir -p artifacts
        mv pkg.deb artifacts/observer-pattern.deb
        sha256sum artifacts/observer-pattern.deb > artifacts/SHA256SUMS
        echo "–°–æ–∑–¥–∞–Ω –ø–∞–∫–µ—Ç:"
        ls -lh artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: |
          artifacts/observer-pattern.deb
          artifacts/SHA256SUMS
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: debian-package
        path: release-assets

    - name: Verify package
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞..."
        dpkg-deb -I release-assets/observer-pattern.deb
        dpkg-deb -c release-assets/observer-pattern.deb

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release-assets/observer-pattern.deb
          release-assets/SHA256SUMS
        body: |
          ## üöÄ –°–æ–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ Observer Pattern

          ### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          - **–í–µ—Ä—Å–∏—è –ø–∞–∫–µ—Ç–∞:** 1.0-$(date +%Y%m%d-%H%M%S)
          - **–ö–æ–º–º–∏—Ç:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          ```bash
          # –°–∫–∞—á–∞—Ç—å –ø–∞–∫–µ—Ç
          wget ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/observer-pattern.deb

          # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
          sudo apt install ./observer-pattern.deb

          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É
          sha256sum -c SHA256SUMS
          ```

          ### –ò–∑–º–µ–Ω–µ–Ω–∏—è
          ${{ github.event.release.body }}